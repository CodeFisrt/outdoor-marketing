<div class="loading-container" *ngIf="loading">
  <div class="spinner"></div>
  <p>Loading Details...</p>
</div>

<!-- ‚úÖ A. BOARD DETAILS VIEW -->
<div class="full-page-container" *ngIf="!loading && board">
  <!-- Premium Card Container -->
  <div class="premium-details-card" *ngIf="currentSection === 'details'">
    <!-- Close/Back Button -->
    <!-- <button class="close-btn" (click)="goBack()">‚úñ</button> -->
    <button class="back-btn" (click)="goBack()">

      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M19 12H5M12 19l-7-7 7-7" />
      </svg>

    </button>

    <div class="card-layout">
      <!-- Left Side: Hero Image -->
      <div class="image-section">
        <div class="image-wrapper">
          <img [src]="board.image" [alt]="board.hoardingType" class="hero-image"
            (error)="board.image = 'assets/billboardimg.jpg'" />
          <div class="status-badge"
            [ngClass]="board.availability === 'Available' ? 'status-available' : 'status-booked'">
            {{ board.availability }}
          </div>
          <div class="action-btn-container">
            <!-- üìÑ PREVIEW PDF -->
            <button *ngIf="pdfUrl && isLoggedIn" class="action-btn preview" (click)="previewHoardingPdf()">
              <i class="bi bi-eye-fill"></i>
              Preview PDF
            </button>

            <!-- ‚¨áÔ∏è DOWNLOAD PDF -->
            <!-- <button *ngIf="pdfUrl && isLoggedIn" class="action-btn download" (click)="downloadHoardingPdf()">
              <i class="bi bi-download"></i>
              Download PDF
            </button> -->

            <!-- üßä VIEW 3D (LAST ALWAYS) -->
            <button *ngIf="board.latitude || board.longitude" class="action-btn view3d"
              (click)="view3D(board.latitude, board.longitude)">
              <i class="bi bi-badge-3d"></i>
              View in 3D
            </button>
          </div>
        </div>
      </div>

      <!-- Right Side: Content & Details -->
      <div class="content-section">
        <div class="header-info">
          <div class="service-tag">{{ board.district }}</div>
          <h1 class="main-title">{{ board.hoardingType }}</h1>
          <p class="location-sub">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
              <circle cx="12" cy="10" r="3"></circle>
            </svg>
            {{ board.location }}
          </p>
        </div>

        <div class="price-box">

          <div class="price-container">

            <!-- LEFT -->
            <div class="price-column">
              <span class="price-label">Price per unit</span>
              <span class="price-val">
                ‚Çπ {{ board.price | maskPrice }}
              </span>
            </div>

            <!-- RIGHT -->
            <div class="price-column text-end">
              <span class="price-label">Current Highest Bid</span>
              <span class="bid-amount">
                ‚Çπ {{ highestBidAmount | number:'1.0-0' }}/-
              </span>
            </div>

          </div>

        </div>

        <!-- Dynamic Grid Attributes -->
        <div class="attributes-grid">
          <div class="attr-item" *ngFor="let attr of board.attributes">
            <span class="attr-label">{{ attr.label }}</span>
            <span class="attr-val">{{ attr.value }}</span>
          </div>
          <!-- Always show Contact if available -->
          <div class="attr-item" *ngIf="board.contactName">
            <span class="attr-label">Contact Person</span>
            <span class="attr-val">{{ board.contactName }}</span>
          </div>
          <div class="attr-item" *ngIf="board.contactNum">
            <span class="attr-label">Phone</span>
            <span class="attr-val">{{ board.contactNum }}</span>
          </div>

          <div class="attr-item">
            <!-- <h3>Description</h3> -->
            <span class="attr-label">Description</span>
            <span class="attr-val">{{
              board.description || 'No description available for this service.'
              }}</span>
            <!-- <p>{{ board.description || 'No description available for this service.' }}</p> -->
          </div>
        </div>

        <!-- üìç MAP VIEW -->
        <div class="map-card" *ngIf="board?.lat && board?.lng">
          <h5 class="map-title">Location on Map</h5>

          <iframe width="100%" height="260" frameborder="0" style="border: 0; border-radius: 12px" loading="lazy"
            allowfullscreen [src]="mapUrl">
          </iframe>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
          <button class="btn-premium btn-book" *ngIf="board.availability === 'Available'" (click)="showSection('book')">
            Book Now
          </button>
          <button class="btn-premium btn-schedule"
            *ngIf="board.availability === 'Available' || board.availability === 'Booked'"
            (click)="showSection('schedule')">
            Schedule Visit
          </button>
          <button class="btn-premium btn-bid" (click)="handleBidClick()">
            Place Bid
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- SUB SECTIONS (Retained structure but wrapped nicely) -->

  <!-- BOOK NOW SECTION -->
  <div *ngIf="currentSection === 'book'" class="sub-section-container">
    <button class="back-link" (click)="showSection('details')">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M19 12H5M12 19l-7-7 7-7" />
      </svg>
      Back to Details
    </button>

    <div class="form-card animate-in">
      <div class="form-header">
        <div class="icon-bg">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
            <line x1="16" y1="13" x2="8" y2="13"></line>
            <line x1="16" y1="17" x2="8" y2="17"></line>
            <polyline points="10 9 9 9 8 9"></polyline>
          </svg>
        </div>
        <div>
          <h3>Book this Service</h3>
          <p class="sub-text">Fill in the details to reserve your spot.</p>
        </div>
      </div>

      <!-- Personal Details -->
      <div class="form-group">
        <label>Full Name</label>
        <div class="modern-input-group">
          <div class="input-icon">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
          </div>
          <input type="text" class="modern-input" [(ngModel)]="bookingDetails.fullName" placeholder="John Doe" />
        </div>
      </div>

      <div class="row-inputs">
        <div class="form-group">
          <label>Email Address</label>
          <div class="modern-input-group">
            <div class="input-icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                <polyline points="22,6 12,13 2,6"></polyline>
              </svg>
            </div>
            <input type="email" class="modern-input" [(ngModel)]="bookingDetails.email"
              placeholder="john@example.com" />
          </div>
        </div>
        <div class="form-group">
          <label>Contact Number</label>
          <div class="modern-input-group">
            <div class="input-icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path
                  d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z">
                </path>
              </svg>
            </div>
            <input type="tel" class="modern-input" [(ngModel)]="bookingDetails.phone" placeholder="+91 98765 43210"
              maxlength="10" />
          </div>
        </div>
      </div>

      <!-- Design Options -->
      <div class="form-group">
        <label>Do you have the design/creative ready?</label>
        <div class="selection-cards">
          <div class="selection-card" [class.selected]="bookingDetails.designReady === 'Yes'"
            (click)="bookingDetails.designReady = 'Yes'">
            <div class="card-icon">üé®</div>
            <div class="card-text">Yes, I have it</div>
          </div>
          <div class="selection-card" [class.selected]="bookingDetails.designReady === 'No'"
            (click)="bookingDetails.designReady = 'No'">
            <div class="card-icon">‚ùå</div>
            <div class="card-text">No, I don't</div>
          </div>
        </div>
      </div>

      <div class="form-group animate-slide-down" *ngIf="bookingDetails.designReady === 'No'">
        <label>Do you want our design team to create the design?</label>
        <div class="selection-cards">
          <div class="selection-card" [class.selected]="bookingDetails.needDesignService === 'Yes'"
            (click)="bookingDetails.needDesignService = 'Yes'">
            <div class="card-icon">üñåÔ∏è</div>
            <div class="card-text">Yes, please</div>
          </div>
          <div class="selection-card" [class.selected]="bookingDetails.needDesignService === 'No'"
            (click)="bookingDetails.needDesignService = 'No'">
            <div class="card-icon">üë§</div>
            <div class="card-text">No, I'll manage</div>
          </div>
        </div>
      </div>

      <!-- Dates -->
      <div class="row-inputs">
        <div class="form-group">
          <label>Start Date</label>
          <div class="modern-input-group">
            <div class="input-icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
              </svg>
            </div>
            <input type="date" class="modern-input" [(ngModel)]="bookingDetails.startDate" [min]="minDate"
              (change)="calculateTotalCost()" />
          </div>
        </div>
        <div class="form-group">
          <label>End Date</label>
          <div class="modern-input-group">
            <div class="input-icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
              </svg>
            </div>
            <input type="date" class="modern-input" [(ngModel)]="bookingDetails.endDate" [min]="minDate"
              (change)="calculateTotalCost()" />
          </div>
        </div>
      </div>

      <!-- Price Estimation Box -->
      <div class="price-summary-box animate-in" *ngIf="totalCost > 0">
        <div class="summary-row">
          <span>Unit Price:</span>
          <strong>‚Çπ{{ board.price }} / day</strong>
        </div>
        <div class="summary-row">
          <span>Duration:</span>
          <strong>{{ durationDays }} Days</strong>
        </div>
        <div class="total-row">
          <span>Total Estimated Cost</span>
          <span class="total-amount">‚Çπ{{ totalCost | number: '1.0-0' }}</span>
        </div>
      </div>

      <!-- Payment -->
      <div class="form-group">
        <label>Payment Method</label>
        <div class="selection-cards">
          <div class="selection-card" [class.selected]="bookingDetails.paymentCompleted === 'Yes'"
            (click)="bookingDetails.paymentCompleted = 'Yes'">
            <div class="card-icon">üí≥</div>
            <div class="card-text">Pay Now</div>
          </div>
          <div class="selection-card" [class.selected]="bookingDetails.paymentCompleted === 'No'"
            (click)="bookingDetails.paymentCompleted = 'No'">
            <div class="card-icon">‚è≥</div>
            <div class="card-text">Pay Later</div>
          </div>
        </div>
        <div class="alert-box warning" *ngIf="bookingDetails.paymentCompleted === 'No'">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="12"></line>
            <line x1="12" y1="16" x2="12.01" y2="16"></line>
          </svg>
          <small>Booking will be pending until payment is confirmed.</small>
        </div>
      </div>

      <!-- Repeat Service -->
      <div class="form-group">
        <label>Recurring Booking?</label>
        <div class="select-wrapper">
          <select class="modern-input" [(ngModel)]="bookingDetails.repeatService">
            <option value="Yes">Yes, I'm interested in repeating this</option>
            <option value="No">No, just this one time</option>
          </select>
        </div>
      </div>

      <!-- Terms -->
      <div class="form-group checkbox-group">
        <label class="custom-checkbox">
          <input type="checkbox" [(ngModel)]="bookingDetails.agreedToTerms" />
          <span class="checkmark">
            <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3">
              <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
          </span>
          <span class="label-text">I agree to the <a href="#">Terms and Conditions</a></span>
        </label>
      </div>

      <button class="btn-primary-action" (click)="submitBooking()"
        [disabled]="bookingDetails.paymentCompleted === 'No' || !bookingDetails.agreedToTerms" [ngClass]="{
          'disabled-btn': bookingDetails.paymentCompleted === 'No' || !bookingDetails.agreedToTerms,
        }">
        <span>Confirm Booking</span>
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M5 12h14M12 5l7 7-7 7" />
        </svg>
      </button>
    </div>
  </div>

  <!-- SCHEDULE SECTION -->
  <div *ngIf="currentSection === 'schedule'" class="sub-section-container">
    <button class="back-link" (click)="showSection('details')">‚Üê Back to Details</button>
    <div class="form-card">
      <h3>‚è≥ Schedule a Visit</h3>
      <div class="form-group">
        <label>Select Date</label>
        <input type="date" />
      </div>
      <div class="form-group">
        <label>Time Slot</label>
        <select>
          <option>10:00 AM - 01:00 PM</option>
          <option>02:00 PM - 05:00 PM</option>
        </select>
      </div>
      <button class="btn-primary-action btn-sched">Confirm Schedule</button>
    </div>
  </div>

  <!-- BIDDING SECTION -->
  <div *ngIf="currentSection === 'bidding'" class="sub-section-container">
    <button class="back-link" (click)="showSection('details')">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M19 12H5M12 19l-7-7 7-7" />
      </svg>
      Back to Details
    </button>

    <div class="form-card animate-in">
      <div class="form-header">
        <div class="icon-bg bidding-icon">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <path d="M16 8l-4 4-4-4"></path>
            <path d="M12 12v7"></path>
          </svg>
        </div>
        <div>
          <h3>Real-Time Bidding</h3>
          <p class="sub-text">Join the auction for this {{ productType }}.</p>
        </div>
      </div>

      <!-- Highest Bid Display -->
      <div class="highest-bid-card" [class.user-is-highest]="bids.length > 0 && bids[0].user_id.toString() === userId">
        <div class="bid-label">Current Highest Bid</div>
        <div class="bid-amount">
          ‚Çπ {{ highestBidAmount | number: '1.0-0' }}/-
        </div>
        <div class="bidder-status" *ngIf="bids.length > 0">
          <span class="badge" [ngClass]="bids[0].user_id.toString() === userId ? 'badge-your' : 'badge-other'">
            {{ bids[0].user_id.toString() === userId ? 'Your Bid' : 'Other Bid' }}
          </span>
          <span class="bidder-name">by {{ bids[0].userName || 'User ' + bids[0].user_id }}</span>
        </div>
        <div class="no-bids" *ngIf="bids.length === 0">No bids placed yet. Start the auction!</div>
      </div>

      <!-- Place Bid Form -->
      <div class="place-bid-form">
        <div class="form-group">
          <label>Your Next Bid Amount (Min: ‚Çπ{{ highestBidAmount | number: '1.0-0' + 100 }})</label>
          <div class="modern-input-group">
            <div class="input-icon">‚Çπ</div>
            <input type="number" class="modern-input" [(ngModel)]="nextBidAmount" [min]="highestBidAmount + 100"
              placeholder="Enter bid amount" />
          </div>
        </div>
        <button class="btn-primary-action" (click)='placeBid()'>
          <span>Place Bid</span>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M5 12h14M12 5l7 7-7 7" />
          </svg>
        </button>
      </div>

      <!-- Bids Table -->
      <div class="bids-history" *ngIf="bids.length > 0">
        <h4>Bid History</h4>
        <div class="table-container">
          <table class="bids-table">
            <thead>
              <tr>
                <th>User</th>
                <th>Amount</th>
                <th>Time</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let bid of bids" [class.highlight-user-bid]="bid.user_id.toString() === userId">
                <td>{{ bid.userName || 'User ' + bid.user_id }}</td>
                <td class="amount-cell">‚Çπ {{ bid.amount | number: '1.2-2' }}</td>
                <td class="time-cell">{{ bid.created_at | date: 'short' }}</td>
                <td>
                  <span class="row-badge" *ngIf="bid.user_id.toString() === userId">You</span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>